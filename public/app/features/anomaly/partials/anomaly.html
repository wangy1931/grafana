
<navbar icon="fa fa-fw fa-stethoscope" title="智能检测">
	<ul class="nav">
    <li class="active" ><a>列表</a></li>
    <li><a href="/anomaly/history">历史</a></li>
  </ul>
</navbar>

<div class="page-container">
  <div class="page-header">
    <h2>自动异常探测 <span style="font-size: 17px">{{system}}</span></h2>
  </div>
  <div class="grafana-info-box" style="margin: 20px 0 25px 0">
    自动异常检测可对当前系统进行自动扫描，Cloudwiz智能运维分析平台将根据其历史数据，分析其异常情况，为监控系统健康状态提供参考依据。
  </div>
  <div class="page" style="max-width: 100%">
    <div class="anomaly-header">
      <div class="system-item">
        <h3 class="center">数据点检测统计</h3>
        <div id="anomaly-point-pie" style="width: 150px; height: 150px; margin:0 auto 20px;"></div>
        <div class="system-item-legend anomaly-item-legend">
            <dl class="small-dl" style="width: 50%;">
                <dt><span class="system-label system-label-success">正常点数<tip>计算机扫描数据点</tip></span></dt>
                <dd class="system-legend system-legend-success">{{pieData.normalPointNum}}({{pieData.normalPointPer}}%)</dd>
            </dl>
            <dl class="small-dl" style="width: 50%;">
                <dt><span class="system-label system-label-warning">异常点数<tip>计算机扫描数据点</tip></span></dt>
                <dd class="system-legend system-legend-warning">{{pieData.anomalyPointNum}}({{pieData.anomalyPointPer}}%)</dd>
            </dl>
        </div>
        <div class="clearfix"></div>
      </div>
      <div class="system-item">
        <h3 class="center">指标检测统计</h3>
        <div id="anomaly-pie" style="width: 150px; height: 150px; margin:0 auto 20px;"></div>
        <div class="system-item-legend anomaly-item-legend">
            <dl class="small-dl">
                <dt><span class="system-label system-label-success">正常指标</span></dt>
                <dd class="system-legend system-legend-success">{{pieData.normalMetricNum}}({{pieData.normalMetricPer}}%)</dd>
            </dl>
            <dl class="small-dl">
                <dt><span class="system-label system-label-warning">临时异常<tip>指标临时异常,一般不影响系统性能</tip></span></dt>
                <dd class="system-legend system-legend-warning">{{pieData.criticalMetricNum}}({{pieData.criticalMetricPer}}%)</dd>
            </dl>
            <dl class="small-dl">
                <dt><span class="system-label system-label-danger">持续异常<tip>指标持续异常,请关注</tip></span></dt>
                <dd class="system-legend system-legend-danger">{{pieData.dangerMetricNum}}({{pieData.dangerMetricPer}}%)</dd>
            </dl>
        </div>
        <div class="clearfix"></div>
      </div>
      <div id="cluster" style="width: 400px; height: 300px; margin-top: 24px;"></div>
    </div>

    
    <div ng-if="!summary.numAnomalyMetrics">
      <em>系统一切正常</em>
    </div>

    <tabset class="anomaly-container" ng-if="summary.numAnomalyMetrics">
      <tab heading="聚合分析">
        <div>
          <div class="accordion cluster-list" id="accordion2">
            <div class="accordion-group cluster-item" ng-repeat="cluster in metricHostClusters | orderBy: 'health'" ng-if="cluster.elements.length" ng-class="{true: 'anomaly-danger'}[cluster.counter.unhealth >= 1/4*cluster.elements.length]">
              <div class="accordion-heading">
                <a class="accordion-toggle" data-toggle="collapse" data-parent="#accordion2" href="#{{$index}}" ng-click="selectCluster($index);">
                  <h4>
                    <span class="pull-left">
                      <i class="fa btn btn-primary" ng-class="{true: 'fa-minus', false: 'fa-plus'}[$index === selected]"></i>
                      <i class="fa fa-file-text-o"></i>
                      平均健康值: 
                      <em>{{cluster.health}}%</em>
                    </span>
                    <span ng-if="cluster.counter.unhealth" class="pull-left">持续异常指标:<em class="danger-color">{{cluster.counter.unhealth}}个</em></span>
                    <a href="/anomaly/{{cluster.index}}" class="btn btn-primary pull-right">查看详情</a>
                    <div class="clearfix"></div>
                  </h4>
                </a>
              </div>
              <div id="{{$index}}" class="accordion-body collapse" ng-class="{true: 'in'}[$index === 0]">
                <div class="accordion-inner">
                  <table class="table table-hover table-striped">
                    <tr ng-repeat="element in cluster.elements">
                      <td><p class="text-overflow" bs-tooltip="'{{_.getMetricName(element.metric)}}'" data-placement="bottom" data-container="body">{{_.getMetricName(element.metric)}}</p></td>
                      <td><p class="text-overflow" style="width: 100px;">{{element.host}}</p></td>
                      <td>{{element.health}}%</td>
                      <td style="text-align: right;"><a ng-click="exclude(element);dismiss();"><i bs-tooltip="'暂缓报警'" data-placement="bottom" data-container="body" class="fa fa-bell-slash-o pointer"></i></a></td>
                    </tr>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="clearfix"></div>
      </tab>
      <tab heading="暂缓报警">
        <div>
          <h3>暂缓异常报警指标</h3>
          <p>共有{{excludeMetricsData.length}}个指标不参与健康值计算
            <tip>剔除噪声值,减少对健康值的影响</tip>
          </p>
          <table class="table" ng-if="excludeMetricsData.length">
            <tr>
              <th>指标名称</th>
              <th>主机名</th>
              <th>健康值</th>
              <th>修改</th>
            </tr>
            <tr ng-repeat="anomalyDef in excludeMetricsData | orderBy:'metric'">
              <td>{{_.getMetricName(anomalyDef.metric)}}</td>
              <td>{{anomalyDef.host}}</td>
              <td>{{anomalyDef.health}}</td>
              <td><a ng-click="include(anomalyDef);" class="btn btn-primary">参与计算</a></td>
            </tr>
          </table>
        </div>
      </tab>
    </tabset>
  </div>
</div>