<div ng-controller="AlertStatusCtrl as ctrl" ng-init="ctrl.init()">
  <div class="grafana-list-item" style="margin-bottom: 40px; min-width: auto;">
    <ul class="tight-form-list">
      <li class="tight-form-item">
        查询历史
      </li>
      <li>
        <select style="width: 110px" 
          ng-model="ctrl.alertTimeSelected" 
          ng-options="item.value for item in ctrl.alertHistoryRange"
          ng-change="ctrl.getAlertHistory(ctrl.alertTimeSelected)"
          >
        </select>
      </li>
      <li style="padding-left: 20px">
        <input type="text" class="input-large" required placeholder="请输入需要查询内容" ng-model="ctrl.alertKey"/>
      </li>
      <li>
        <span class="tight-form-btn btn btn-success btn-small" style="margin: 3px 20px;">
          <i class="fa fa-fw fa-search"></i>查询
        </span>
      </li>
    </ul>
    <div class="clearfix"></div>
  </div>

  <div ng-hide="ctrl.alertRows.length || ctrl.alertHistory.length">
    <em>暂没有任何报警数据</em>
    <cw-loading show="!ctrl.alertRows.length" duration=6000></cw-loading>
  </div>

  <div ng-show="ctrl.alertRows.length && ctrl.alertStatusShow">
    <p>
      <span style="font-size: 12px">（实时）</span>
      <span>触发的报警规则总数：{{ ctrl.alertRows.length }}</span>
      <span>严重报警数：{{ ctrl.alertCriticalCount }}</span>
      <span>警告报警数：{{ ctrl.alertWarningCount }}</span>
    </p>
    <table class="grafana-options-table table-block" ng-show="ctrl.alertRows.length">
      <thead>
        <tr>
          <th>规则清楚</th>
          <th>主机名称</th>
          <th>报警指标</th>
          <th>报警值/阈值</th>
          <th>当前值</th>
          <th>报警级别</th>
          <th>报警时间</th>
          <th>再次报警时间<tip>如果报警没有解决, 将重复报警</tip></th>
          <th>操作</th>
        </tr>
      </thead>
      <tbody>
        <tr ng-repeat="alertDetail in ctrl.alertRows | filter: alertKey">
          <td>
            <i class="fa fa-bell" ng-class="{'CRITICAL':'system-legend-danger','WARNING':'system-legend-warning'}[alertDetail.status.level]"></i> &nbsp;
            {{ alertDetail.definition.name }}
          </td>
          <td>{{ alertDetail.status.monitoredEntity }}</td>
          <td>{{ _.getMetricName(alertDetail.metric) }}</td>
          <td>
            <strong>{{ alertDetail.status.triggeredValue }}</strong>/{{ alertDetail.definition.alertDetails.threshold }}
          </td>
          <td>{{ alertDetail.curAlertValue }}</td>
          <td>{{ _.translateAlertLevel(alertDetail.status.level) }}</td>
          <td>{{ _.transformMillionTime(alertDetail.status.levelChangedTime) }}</td>
          <td>{{ _.transformTimeFrom(alertDetail.status.levelChangedTime, alertDetail.status.snoozeMinutes, 'm') }}</td>
          <td>
            <a ng-click="ctrl.associateAnalysis(alertDetail.status.monitoredEntity, alertDetail.metric, alertDetail)"
              href="javascript:;"
              class="btn btn-mini btn-primary">
              <i class="fa fa-signal"></i> 诊断分析
            </a>
            <a class="btn btn-mini btn-success" ng-click="ctrl.handleSnooze(alertDetail)">
              延迟报警
            </a>
            <a class="btn btn-mini btn-success" ng-click="ctrl.handleAlert(alertDetail)">
              处理警告
            </a>
            <a class="btn btn-mini btn-success" ng-click="ctrl.handleRCAFeedback(alertDetail)">
              添加根源原因
            </a>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div ng-hide="ctrl.alertStatusShow">
    <table class="grafana-options-table table-block" ng-show="ctrl.alertHistory.length">
      <thead>
        <tr>
          <th>报警名称</th>
          <th>机器名称</th>
          <th>指标名称</th>
          <th class="history-type">报警类型</th>
          <th>报警值/阈值</th>
          <th class="hitstory-time">报警时间</th>
          <th class="hitstory-time">处理时间</th>
          <th>处理人员</th>
          <th>处理方法</th>
          <th>报警分析</th>
        </tr>
      </thead>
      <tbody>
        <tr ng-repeat="alert in ctrl.alertHistory | orderBy:closedTimeInMillis:true | filter: ctrl.alertKey">
          <td>
            <i class="fa fa-bell" ng-class="{'CRITICAL':'system-legend-danger','WARNING':'system-legend-warning'}[alert.status.level]"></i> &nbsp;
            {{ alert.definition.name }}
          </td>
          <td>{{ alert.history.host }}</td>
          <td>{{ alert.definition.alertDetails.hostQuery.metricQueries[0].metric }}</td>
          <td class="history-type">{{ _.translateAlertLevel(alert.history.level) }}</td>
          <td>
            <strong>{{ alert.history.triggeredValue | limitTo:5 }}</strong> / {{ alert.definition.alertDetails[getAlertType(alert)].threshold }}
          </td>
          <td class="hitstory-time">{{ alert.history.createdTimeInMillis | date:'yyyy-MM-dd HH:mm:ss' }}</td>
          <td class="hitstory-time">{{ alert.history.closedTimeInMillis | date:'yyyy-MM-dd HH:mm:ss' }}</td>
          <td>{{ ctrl.getCloseOp(alert) }}</td>
          <td><span ng-if="alert.history.closeOp === 'MANUAL'">{{ alert.history.reason }}</span></td>
          <td style="width: 120px;">
            <a href="/rca?guide&host={{ alert.history.host }}&metric={{alert.definition.alertDetails.hostQuery.metricQueries[0].metric}}&start={{ alert.history.createdTimeInMillis }}"
              class="btn btn-mini btn-primary">
              <i class="fa fa-signal"></i> 诊断分析
            </a>
            <!-- <a class="btn btn-mini btn-primary" ng-click="historyAnalysis(alert.id)">
              历史报警分析
            </a> -->
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>